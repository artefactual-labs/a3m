name: Tests
on:
  pull_request:
  push:
    branches:
    - main
jobs:
  tests:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - name: "Python 3.11"
          python: "3.11"
          os: "ubuntu-latest"
          codecov: yes
          experimental: false
        - name: "Python 3.12"
          python: "3.12"
          os: "ubuntu-latest"
          codecov: no
          experimental: true
    steps:
    - name: "Check out source code"
      uses: "actions/checkout@v4"
    - name: "Install ${{ matrix.name }}"
      uses: "actions/setup-python@v4"
      with:
        python-version: ${{ matrix.python }}
        cache: "pip"
        cache-dependency-path: "requirements-dev.txt"
    - name: "Install dependencies"
      run: "pip install -r requirements-dev.txt"
    - name: "Run tests"
      run: "make test"
    - name: "Codecov"
      uses: "codecov/codecov-action@v3"
      with:
        file: "./.coverage.xml"
      if: ${{ matrix.codecov }}
  e2e:
    name: e2e
    runs-on: ubuntu-latest
    steps:
    - name: Check out source code
      uses: actions/checkout@v2
    - name: Build Docker image
      run: |
        make build
      shell: bash
    - name: Run command
      run: |
        docker run --rm --entrypoint=python --env=A3M_DEBUG=yes a3m-a3m -m a3m.cli.client \
          --name=MARBLES \
          https://github.com/artefactual/archivematica-sampledata/raw/master/SampleTransfers/Images/pictures/MARBLES.TGA
